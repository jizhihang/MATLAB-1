function fig = dJPST(action);
global defaultCalculation;
global xList;
global Version;
global verbose;
global xHist;
global yHist;
global matrix;
global rasterDisplayTrials;



if exist('action')
   switch(action)
      
   case('closeall')
   cf = findobj('Tag','JPSTSettings');
   if ~isempty(cf)
  		set(cf,'CloseRequestFcn', 'closereq');
	   close(cf);
   end
   cf = findobj('Tag','JPSTMain');
   if ~isempty(cf)
  		set(cf,'CloseRequestFcn', 'closereq');
	   close(cf);
   end

   case('print')
   if ~isempty(xList);
      cf = findobj('Tag','JPSTMain');
      if ~isempty(cf)
        orient landscape
        printdlg
  	  	end
   end
   
   case('normalizationMode')
   cf = findobj('Tag','trialnormalize');
   if strcmp(get(cf,'checked'),'on')
      set(cf,'checked','off');
      JPST('setNormalizeMethod',0);
   else   
      set(cf,'checked','on');
      JPST('setNormalizeMethod',1);
   end
   
   case('addRasters')
   cf = findobj('Tag','raster');
   if ~isempty(cf)
      if strcmp(get(cf,'checked'),'on')
         set(cf,'checked','off');
         sx = xHist;
         sy = yHist;
         xHist = [];
         yHist = [];
         JPSTGUI('plotXHist')	% erase histogram in old location
         JPSTGUI('plotYHist')
         xHist = sx;
         yHist = sy;
         JPSTGUI('defaultDisplay');
         JPSTGUI('plotXHist') % draw histgram in new location
         JPSTGUI('plotYHist')
      else
         set(cf,'checked','on');
         JPSTRasterOptions('open');
      end   
   end
   
   
   case('verbose')
   cf = findobj('Tag','verbose');
   if ~isempty(cf)
      verbose = ~verbose;
      JPST('setVerbose',verbose);
      if verbose
         set(cf,'checked','on');
      else
         set(cf,'checked','off');
      end   
   end
      
   end % switch statement   
else

cf = findobj('tag','JPSTMain');
if ~isempty(cf)
   figure(cf);
   return;
end

xHist = [];
yHist = [];
matrix = [];
Version = 'JPST v0.01';
defaultCalculation = 'calcCorrected';
JPST('setVerbose',1);	% turn verbose on to start
JPST('setNormalizeMethod',1);  % normalize by trial number
JPSTGUI('setRasterDisplayTrials',100);

h0 = figure('Color',[1 1 1], ...
   'Name',[Version ' - no gdf file loaded'], ...
   'MenuBar','none', ...
	'NumberTitle','off', ...
	'Position',[55 98 560 420], ...
   'CloseRequestFcn', 'dJPST closeall', ...
	'Tag','JPSTMain');
h1 = uimenu('Parent',h0, ...
	'Label','&File', ...
	'Tag','File');
h2 = uimenu('Parent',h1, ...
	'Callback','JPSTGUI openGDF', ...
	'Label','Open GDF...', ...
	'Tag','OpenGDF');
h2 = uimenu('Parent',h1, ...
	'Label','Save...', ...
	'Tag','Save');
h2 = uimenu('Parent',h1, ...
	'Callback','dJPST print', ...
	'Label','Print...', ...
	'Tag','Print');
h1 = uimenu('Parent',h0, ...
	'Label','&Options', ...
	'Tag','Options');
h2 = uimenu('Parent',h1, ...
	'Callback','JPSTSettings open', ...
	'Label','settings...', ...
	'Tag','settings');
h2 = uimenu('Parent',h1, ...
	'Callback','JPSTDefaultOptions open', ...
	'Label','options...', ...
	'Tag','options');
h2 = uimenu('Parent',h1, ...
   'Callback','dJPST normalizationMode', ...
	'Label','normalize by trial number', ...
   'checked','on',...
   'separator','on',...
	'Tag','trialnormalize');
h1 = uimenu('Parent',h0, ...
	'Label','&Display', ...
	'Tag','run');
h2 = uimenu('Parent',h1, ...
	'Callback','JPSTGUI displayRaw', ...
	'Label','raw: JPST', ...
	'Tag','raw');
h2 = uimenu('Parent',h1, ...
	'Callback','JPSTGUI displayPSTprod', ...
	'Label','PSTprod', ...
	'Tag','PSTprod');
h2 = uimenu('Parent',h1, ...
	'Callback','JPSTGUI displayCorrected', ...
	'Label','corrected: JPST-PSTprod', ...
	'Tag','corrected');
h2 = uimenu('Parent',h1, ...
	'Callback','JPSTGUI dispPctExcessCoincidences', ...
	'Label','excess coincidence: (corrected / PSTprod)*100', ...
	'Tag','calcPctExcessCoincidences');
h2 = uimenu('Parent',h1, ...
	'Callback','JPSTGUI displayNormalized', ...
	'Label','normalized: (JPST-PSTprod)/SDPSTprod', ...
   'checked','on',...
	'Tag','normalized');
h2 = uimenu('Parent',h1, ...
   'Callback','JPSTGUI displayStationarity', ...
	'Label','stationarity: (JPST-PSTprod)/PSTSDprod', ...
	'Tag','stationarity');
h2 = uimenu('Parent',h1, ...
	'Callback','JPSTGUI displaySignificance', ...
	'Label','significance: Palm et al 1988', ...
   'Tag','significance');
h2 = uimenu('Parent',h1, ...
   'Callback','JPSTGUI displayBinomialErrors', ...
	'Label','binomial errors', ...
	'Tag','binomialerrors');

t = ['add rasters: show first ' int2str(rasterDisplayTrials) ' trials'];
h2 = uimenu('Parent',h1, ...
   'Callback','dJPST addRasters', ...
	'Label',t, ...
   'checked','off',...
   'separator','on',...
	'Tag','raster');

h2 = uimenu('Parent',h1, ...
   'Callback','dJPST verbose', ...
	'Label','verbose mode', ...
   'checked','on',...
   'separator','on',...
	'Tag','verbose');
if nargout > 0, fig = h0; end

% set default colormap
%load('em.mat');
%colormap(em);
%load('dm.mat');
%colormap(dm);
colormap(jet);

JPSTSettings('open');

drawnow;

% JPSTGUI('openGDF');

end